<?php

use Carbon\CarbonImmutable;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\DB;
use Laravel\Pulse\Facades\Pulse;
use Laravel\Pulse\Livewire\Servers;
use Livewire\Livewire;

it('includes the card on the dashboard', function () {
    Pulse::authorizeUsing(fn () => true);

    $this
        ->get('/pulse')
        ->assertSeeLivewire(Servers::class);
});

it('renders server statistics', function () {
    Carbon::setTestNow('2000-01-02 03:04:05');
    $timestamp = now()->timestamp;

    Pulse::ignore(function () use (&$timestamp) {
        for ($i = 0; $i < 60; $i++) {
            for ($j = 0; $j < (($i + 1) % 3); $j++) {
                DB::table('pulse_entries')->insert([
                    'timestamp' => $timestamp,
                    'type' => 'cpu',
                    'key' => 'web-1',
                    'value' => $i,
                ]);

                DB::table('pulse_entries')->insert([
                    'timestamp' => $timestamp,
                    'type' => 'memory',
                    'key' => 'web-1',
                    'value' => 2 * ($j + 1),
                ]);

                $timestamp += $j;
            }

            $timestamp += 60;
        }

        DB::table('pulse_entries')->insert([
            'timestamp' => $timestamp,
            'type' => 'cpu',
            'key' => 'web-1',
            'value' => 12,
        ]);

        DB::table('pulse_entries')->insert([
            'timestamp' => $timestamp,
            'type' => 'memory',
            'key' => 'web-1',
            'value' => 1234,
        ]);

        DB::table('pulse_values')->insert([
            'key' => 'system:web-1',
            'value' => json_encode([
                'name' => 'Web 1',
                'cpu' => 12,
                'memory_used' => 1234,
                'memory_total' => 2468,
                'timestamp' => $timestamp,
                'storage' => [
                    [
                        'directory' => '/',
                        'used' => 123,
                        'total' => 456,
                    ],
                ],
            ]),
        ]);
    });

    Carbon::setTestNow('2000-01-02 04:04:05');

    Livewire::test(Servers::class, ['lazy' => false])
        ->assertViewHas('time')
        // ->assertViewHas('runAt', '2000-01-02 03:04:15')
        ->assertViewHas('servers', collect([
            'web-1' => (object) [
                'name' => 'Web 1',
                'cpu_current' => 12,
                'memory_current' => 1234,
                'memory_total' => 2468,
                'storage' => [
                    (object) ['directory' => '/', 'used' => 123, 'total' => 456],
                ],
                'cpu' => collect([
                    '2000-01-02 03:05:00' => 1,
                    '2000-01-02 03:06:00' => null,
                    '2000-01-02 03:07:00' => 3,
                    '2000-01-02 03:08:00' => 4,
                    '2000-01-02 03:09:00' => null,
                    '2000-01-02 03:10:00' => 6,
                    '2000-01-02 03:11:00' => 7,
                    '2000-01-02 03:12:00' => null,
                    '2000-01-02 03:13:00' => 9,
                    '2000-01-02 03:14:00' => 10,
                    '2000-01-02 03:15:00' => null,
                    '2000-01-02 03:16:00' => 12,
                    '2000-01-02 03:17:00' => 13,
                    '2000-01-02 03:18:00' => null,
                    '2000-01-02 03:19:00' => 15,
                    '2000-01-02 03:20:00' => 16,
                    '2000-01-02 03:21:00' => null,
                    '2000-01-02 03:22:00' => 18,
                    '2000-01-02 03:23:00' => 19,
                    '2000-01-02 03:24:00' => null,
                    '2000-01-02 03:25:00' => 21,
                    '2000-01-02 03:26:00' => 22,
                    '2000-01-02 03:27:00' => null,
                    '2000-01-02 03:28:00' => 24,
                    '2000-01-02 03:29:00' => 25,
                    '2000-01-02 03:30:00' => null,
                    '2000-01-02 03:31:00' => 27,
                    '2000-01-02 03:32:00' => 28,
                    '2000-01-02 03:33:00' => null,
                    '2000-01-02 03:34:00' => 30,
                    '2000-01-02 03:35:00' => 31,
                    '2000-01-02 03:36:00' => null,
                    '2000-01-02 03:37:00' => 33,
                    '2000-01-02 03:38:00' => 34,
                    '2000-01-02 03:39:00' => null,
                    '2000-01-02 03:40:00' => 36,
                    '2000-01-02 03:41:00' => 37,
                    '2000-01-02 03:42:00' => null,
                    '2000-01-02 03:43:00' => 39,
                    '2000-01-02 03:44:00' => 40,
                    '2000-01-02 03:45:00' => null,
                    '2000-01-02 03:46:00' => 42,
                    '2000-01-02 03:47:00' => 43,
                    '2000-01-02 03:48:00' => null,
                    '2000-01-02 03:49:00' => 45,
                    '2000-01-02 03:50:00' => 46,
                    '2000-01-02 03:51:00' => null,
                    '2000-01-02 03:52:00' => 48,
                    '2000-01-02 03:53:00' => 49,
                    '2000-01-02 03:54:00' => null,
                    '2000-01-02 03:55:00' => 51,
                    '2000-01-02 03:56:00' => 52,
                    '2000-01-02 03:57:00' => null,
                    '2000-01-02 03:58:00' => 54,
                    '2000-01-02 03:59:00' => 55,
                    '2000-01-02 04:00:00' => null,
                    '2000-01-02 04:01:00' => 57,
                    '2000-01-02 04:02:00' => 58,
                    '2000-01-02 04:03:00' => null,
                    '2000-01-02 04:04:00' => 12,
                ]),
                'memory' => collect([
                    '2000-01-02 03:05:00' => 3,
                    '2000-01-02 03:06:00' => null,
                    '2000-01-02 03:07:00' => 2,
                    '2000-01-02 03:08:00' => 3,
                    '2000-01-02 03:09:00' => null,
                    '2000-01-02 03:10:00' => 2,
                    '2000-01-02 03:11:00' => 3,
                    '2000-01-02 03:12:00' => null,
                    '2000-01-02 03:13:00' => 2,
                    '2000-01-02 03:14:00' => 3,
                    '2000-01-02 03:15:00' => null,
                    '2000-01-02 03:16:00' => 2,
                    '2000-01-02 03:17:00' => 3,
                    '2000-01-02 03:18:00' => null,
                    '2000-01-02 03:19:00' => 2,
                    '2000-01-02 03:20:00' => 3,
                    '2000-01-02 03:21:00' => null,
                    '2000-01-02 03:22:00' => 2,
                    '2000-01-02 03:23:00' => 3,
                    '2000-01-02 03:24:00' => null,
                    '2000-01-02 03:25:00' => 2,
                    '2000-01-02 03:26:00' => 3,
                    '2000-01-02 03:27:00' => null,
                    '2000-01-02 03:28:00' => 2,
                    '2000-01-02 03:29:00' => 3,
                    '2000-01-02 03:30:00' => null,
                    '2000-01-02 03:31:00' => 2,
                    '2000-01-02 03:32:00' => 3,
                    '2000-01-02 03:33:00' => null,
                    '2000-01-02 03:34:00' => 2,
                    '2000-01-02 03:35:00' => 3,
                    '2000-01-02 03:36:00' => null,
                    '2000-01-02 03:37:00' => 2,
                    '2000-01-02 03:38:00' => 3,
                    '2000-01-02 03:39:00' => null,
                    '2000-01-02 03:40:00' => 2,
                    '2000-01-02 03:41:00' => 3,
                    '2000-01-02 03:42:00' => null,
                    '2000-01-02 03:43:00' => 2,
                    '2000-01-02 03:44:00' => 3,
                    '2000-01-02 03:45:00' => null,
                    '2000-01-02 03:46:00' => 2,
                    '2000-01-02 03:47:00' => 3,
                    '2000-01-02 03:48:00' => null,
                    '2000-01-02 03:49:00' => 2,
                    '2000-01-02 03:50:00' => 3,
                    '2000-01-02 03:51:00' => null,
                    '2000-01-02 03:52:00' => 2,
                    '2000-01-02 03:53:00' => 3,
                    '2000-01-02 03:54:00' => null,
                    '2000-01-02 03:55:00' => 2,
                    '2000-01-02 03:56:00' => 3,
                    '2000-01-02 03:57:00' => null,
                    '2000-01-02 03:58:00' => 2,
                    '2000-01-02 03:59:00' => 3,
                    '2000-01-02 04:00:00' => null,
                    '2000-01-02 04:01:00' => 2,
                    '2000-01-02 04:02:00' => 3,
                    '2000-01-02 04:03:00' => null,
                    '2000-01-02 04:04:00' => 1234,
                ]),
                'updated_at' => CarbonImmutable::createFromTimestamp($timestamp),
                'recently_reported' => true,
            ],
        ]));
});
